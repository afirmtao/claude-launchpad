FROM archlinux:latest

# Update system and install base packages
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm base-devel nodejs npm sudo docker docker-compose docker-buildx zellij && \
    pacman -Scc --noconfirm

# Create non-root user and add to docker group
RUN useradd -m -G wheel,docker -s /bin/bash {{ admin_user }} && \
    echo "{{ admin_user }} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to non-root user
USER {{ admin_user }}
WORKDIR /home/{{ admin_user }}

# Setup Docker Buildx
RUN mkdir -p ~/.docker/cli-plugins

# Configure Zellij with Dracula theme
RUN mkdir -p ~/.config/zellij && \
    echo 'theme "dracula"' > ~/.config/zellij/config.kdl && \
    echo 'default_shell "bash"' >> ~/.config/zellij/config.kdl

# Configure npm and install claude-code
RUN mkdir -p ~/.npm/global && \
    npm config set prefix ~/.npm/global && \
    echo 'export PATH=~/.npm/global/bin:$PATH' >> ~/.bashrc && \
    npm install -g @anthropic-ai/claude-code

# Set environment variables
ENV PATH="/home/{{ admin_user }}/.npm/global/bin:$PATH"

# Keep container running
CMD ["/bin/bash", "-l"]